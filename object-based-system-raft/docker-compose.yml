version: "3.9"

services:
  db-svc:
    image: postgres:15
    container_name: db-svc
    restart: always
    environment:
      POSTGRES_USER: chatuser
      POSTGRES_PASSWORD: chatpass
      POSTGRES_DB: chatdb
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U chatuser -d chatdb"]
      interval: 5s
      timeout: 5s
      retries: 5

  user-svc:
    build:
      context: .
      dockerfile: user-svc/Dockerfile
    container_name: user-svc
    restart: always
    depends_on:
      db-svc:
        condition: service_healthy
    ports:
      - "50052:50051"

  message-svc:
    build:
      context: .
      dockerfile: message-svc/Dockerfile
    container_name: message-svc
    restart: always
    depends_on:
      db-svc:
        condition: service_healthy
    ports:
      - "50054:50051"

  room-svc:
    build:
      context: .
      dockerfile: room-svc/Dockerfile
    container_name: room-svc
    restart: always
    ports:
      - "50053:50051"

  presence-svc:
    build:
      context: .
      dockerfile: presence-svc/Dockerfile
    container_name: presence-svc
    restart: always
    ports:
      - "50055:50051"

  gateway-svc:
    build:
      context: .
      dockerfile: gateway-svc/Dockerfile
    container_name: gateway-svc
    restart: always
    depends_on:
      - user-svc
      - room-svc
      - presence-svc
      - message-svc
    ports:
      - "8080:50051"

  ui-svc:
    build:
      context: .
      dockerfile: ui-svc/Dockerfile
    container_name: ui-svc
    restart: always
    depends_on:
      - gateway-svc
    ports:
      - "5000:5000"

  raft-node-1:
    build: ./raft-node
    environment:
      NODE_ID: "1"
      PEERS: "raft-node-2:6000,raft-node-3:6000,raft-node-4:6000,raft-node-5:6000"
    ports:
      - "6001:6000"

  raft-node-2:
    build: ./raft-node
    environment:
      NODE_ID: "2"
      PEERS: "raft-node-1:6000,raft-node-3:6000,raft-node-4:6000,raft-node-5:6000"

  raft-node-3:
    build: ./raft-node
    environment:
      NODE_ID: "3"
      PEERS: "raft-node-1:6000,raft-node-2:6000,raft-node-4:6000,raft-node-5:6000"

  raft-node-4:
    build: ./raft-node
    environment:
      NODE_ID: "4"
      PEERS: "raft-node-1:6000,raft-node-2:6000,raft-node-3:6000,raft-node-5:6000"

  raft-node-5:
    build: ./raft-node
    environment:
      NODE_ID: "5"
      PEERS: "raft-node-1:6000,raft-node-2:6000,raft-node-3:6000,raft-node-4:6000"
