version: "3.9"

services:
  auth:
    build:
      context: ..
      dockerfile: services/auth/Dockerfile
    environment:
      PYTHONUNBUFFERED: "1"          # <-- ENABLE LOGGING
      JWT_SECRET: ${JWT_SECRET:-devsecret}
      TOKEN_TTL_SECS: ${TOKEN_TTL_SECS:-3600}
      REVOCATION_TTL_SECS: ${REVOCATION_TTL_SECS:-3600}
      AUTH_DB: ${AUTH_DB:-/data/auth.db}
    volumes:
      - authdata:/data
    ports:
      - "50051:50051"

  room:
    build:
      context: ..
      dockerfile: services/room/Dockerfile
    environment:
      PYTHONUNBUFFERED: "1"          # <-- ENABLE LOGGING
      ROOM_DB: ${ROOM_DB:-/data/rooms.db}
    volumes:
      - roomdata:/data
    ports:
      - "50052:50052"

  presence:
    build:
      context: ..
      dockerfile: services/presence/Dockerfile
    environment:
      PYTHONUNBUFFERED: "1"          # <-- ENABLE LOGGING
      PRESENCE_TTL_SECS: ${PRESENCE_TTL_SECS:-20}
      PRESENCE_DB: ${PRESENCE_DB:-/data/presence.db}
    volumes:
      - presencedata:/data
    ports:
      - "50053:50053"

  message:
    build:
      context: ..
      dockerfile: services/message/Dockerfile
    environment:
      PYTHONUNBUFFERED: "1"          # <-- CRITICAL FOR 2PC PRINTS
      MESSAGE_DB: ${MESSAGE_DB:-/data/messages.db}
    volumes:
      - messagedata:/data
    ports:
      - "50054:50054"

  gateway:
    build:
      context: ..
      dockerfile: services/gateway/Dockerfile
    environment:
      PYTHONUNBUFFERED: "1"          # <-- CRITICAL FOR GATEWAY LOGS
      AUTH_ADDR: ${AUTH_ADDR:-auth:50051}
      ROOM_ADDR: ${ROOM_ADDR:-room:50052}
      PRESENCE_ADDR: ${PRESENCE_ADDR:-presence:50053}
      MESSAGE_ADDR: ${MESSAGE_ADDR:-message:50054}
      GATEWAY_BIND: ${GATEWAY_BIND:-0.0.0.0:50055}  
      NODE_ID: "gateway"             # <-- IDENTIFIER FOR LOGGING
    depends_on:
      - auth
      - room
      - presence
      - message
    ports:
      - "50055:50055"

  ui:
    build:
      context: ..
      dockerfile: services/ui/Dockerfile
    environment:
      PYTHONUNBUFFERED: "1"          # <-- UI LOGGING
      GATEWAY_ADDR: gateway:50055
      NODE_ID: "ui-coordinator"      # <-- IDENTIFIER FOR LOGGING
    depends_on:
      - gateway
    ports:
      - "8080:8080"

volumes:
  authdata:
  roomdata:
  messagedata:
  presencedata:

